#!/usr/bin/zsh
#
#         _              _ _                     
#   _   _| |_       __ _| | |__  _   _ _ __ ___  
#  | | | | __|____ / _` | | '_ \| | | | '_ ` _ \ 
#  | |_| | ||_____| (_| | | |_) | |_| | | | | | |
#   \__, |\__|     \__,_|_|_.__/ \__,_|_| |_| |_|
#   |___/ 
#
#
# Download either youtube album playlist or album single video
# and cut the video into tracks. Accepts either a youtube url
# or playlist id.


set -o shwordsplit

function check_dependencies {
  readonly dep=${1:?"Dependency must be specified."}
  if ! type $dep > /dev/null; then
    echo "The '${dep}' dependency was not found."
    exit 1
  fi
}

function download_album {
  readonly url=${1:?"Url must be specified."}
  format="%(title)s.%(ext)s"
  base=`youtube-dl --get-filename --restrict-filenames -o  "%(title)s" "$url"`
  youtube-dl -x -o $format --restrict-filenames --audio-quality 0 --audio-format mp3 "$url"
  mp3splt -s -N -p th=-50,nt=11 ${base}.mp3
}

function download_playlist {
  readonly id=${1:?"Playlist id must be specified."}
  format="%(title)s.%(ext)s"
  youtube-dl -x -i --restrict-filenames --audio-quality 0 --audio-format mp3 "$id"
}

# check if dependencies are installed on system
deps='youtube-dl mp3splt ffmpeg'
for dep in $deps; check_dependencies $dep

# if url download song else accept playlist id
regex='(https?|ftp|file)://[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]'
if [[ $1 =~ $regex ]]; then
  download_album $1
else
  download_playlist $1
fi
